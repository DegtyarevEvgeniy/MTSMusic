{% extends "base.html" %} 

{% block content %}

{% load static %}

{% include "menuRoom.html" %}

<div id="MainWindowContainer" class="uk-width-4-5 uk-margin-auto" >


 


            <div class="uk-child-width-1-2 uk-text-center" uk-grid>

                <div class="uk-width-expand@m">
                    <div class="uk-card uk-card-default uk-card-body">
                        
                        <h1>Комната №{{room.id}}</h1>

                        <h3 class="uk-card-title"> Название: {{room.name}}</h3>
                        <p>Кол-во пользователей: {{room.amount_of_users}}</p>
                
  
                
                        <h2>Выберите песню</h2>
                        <form id="songForm" method="post" enctype="multipart/form-data" uk-grid>
                            {% csrf_token %}
                            {% for song in songs %}
                                <button
                                    class="uk-button uk-button-secondary uk-width-1-3 uk-margin-medium-right uk-border-rounded song-button"
                                    data-song-name="{{ song }}"
                                    data-song-id = "{{ song.id }}"
                                    type="button">
                                    {{ song }}
                                </button>
                            {% endfor %}
                        </form>
                
                        
                        {% if user.room == room.id %}
                        <h4 id="sonng-name">Песня {{room.song}}</h4>
                        <div class="uk-alert-success" uk-alert>
                            <a href class="uk-alert-close" uk-close></a>
                
                            <audio src="{% static 'music/' %}{{ room.song }}" controls autoplay></audio>
                
                        </div>
                        {% endif %}


                    </div>
                </div>

                <div class="uk-width-1-3@m">
                    <div class="uk-card uk-card-default uk-card-body">

                        <form class="uk-grid-small" method="post" enctype="multipart/form-data" uk-grid>
                            {% csrf_token %}
                                <button
                                    class="uk-button uk-button-primary uk-width-2-3 uk-border-rounded"
                                    type="submit" name="AddToRoom">Присоединиться к комнате</button>
                
                                <button
                                    class="uk-button uk-button-danger uk-width-2-3 uk-border-rounded"
                                    type="submit" name="LeaveToRoom">Выйти</button>
                            
                        </form> 

                    </div>
                </div>
                
            </div>
            
        </div>




</div>



<script>
    $(document).ready(function () {
        // Get the CSRF token from the cookie
        var csrftoken = '{{ csrf_token }}';

        $('.song-button').click(function () {
            var selectedSongId = $(this).data('song-id');
            var selectedSongName = $(this).data('song-name');

            // Make an AJAX request to update the selected song
            $.ajax({
                type: 'PUT',
                url: `/api/rooms/{{ room.id }}/select-track/${selectedSongId}`,
                data: {
                    selected_track_id: selectedSongId,
                    selected_track_name: selectedSongName,
                },
                headers: {
                    'X-CSRFToken': csrftoken,  // Include the CSRF token in the headers
                },
                success: function (data) {
                    // Update the UI with the new song information
                    $('#sonng-name').text(`Песня ${selectedSongName}`);

                    // Update the audio source
                    $('audio').attr('src', '{% static "music/" %}' + selectedSongName);

                    console.log('Song selected successfully');
                },
                error: function (error) {
                    // Handle error
                    console.error('Error selecting song:', error);
                }
            });
        });
    });
</script>

<script>
    $(document).ready(function () {
        var selectedSongId;  // Keep track of the selected song ID

        // WebSocket connection for song updates
        var trackTimeSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/rooms/{{ room.id }}/get_track_time/');
        trackTimeSocket.onmessage = function (e) {
            var data = JSON.parse(e.data);
            // Handle song updates, e.g., update the song playback time
        };

        $('.song-button').click(function () {
            selectedSongId = $(this).data('song-id');
            
            // Make an AJAX request to update the selected song
            $.ajax({
                type: 'PUT',
                url: `/api/rooms/{{ room.id }}/select-track/${selectedSongId}`,
                data: {
                    selected_track_id: selectedSongId,
                },
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                success: function (data) {
                    // Optionally update the UI or handle success
                    console.log('Song selected successfully');
                },
                error: function (error) {
                    // Handle error
                    console.error('Error selecting song:', error);
                }
            });
        });
    });
</script>

{% endblock %}
